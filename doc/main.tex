\documentclass[a4paper,12pt]{article}

\usepackage{cmap}
\usepackage{amsmath}
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}

\begin{document}
\section{Модель движения}

Положение робота описывается положением начала подвижной системы координат $B$ в некоторой локальной системе координат $I$, ось $Z_I$ направлена против гравитации, оси $X_I$ и $Y_I$ дополняют систему до правой тройки.

Ориентация робота представлена кватернионом $q$ таким образом, что произвольный вектор, записанный в собственных осях $B$ робота проецируется в локальную систему как
$r_I = q_{IB} \circ r_B \circ \tilde{q}_{IB}$

Движение робота определено текущей ориентацией и управляющим воздействием на приводы колес $v$.
\begin{align} \label{eq:model_velocity}
&\dot{r}_B = (v \quad 0 \quad 0)^T \\
&\dot{r}_I = q_{IB} \circ \dot{r}_B \circ \tilde{q}_{IB}
\end{align}

Текущая ориентация робота определяется поворотом руля, которая определяет локальную кривизну траектории $u$, и вектором нормали $n_s$ к поверхности, по которой перемещается робот.
\begin{align} 
&q_{IB} = q_{\phi} \circ q_{s} \\
&q_{\phi} = (\cos{\frac{\phi}{2}} \quad n_{s}\sin{\frac{\phi}{2}})^T \\
&\dot{\phi} = vu \\
&q_{s} = (\cos{\frac{\psi}{2}} \quad n_{\perp}\sin{\frac{\psi}{2}})^T \\
&\cos{\psi} = e_z \cdot n_s \\
& n_{\perp} ||n_{\perp}|| = e_z \times n_s 
\end{align}

Угловая скорость связана с кватернионом ориентации уравнением Пуассона
\begin{align}  \label{eq:model_rot_velocity}
&\dot{q}_{IB} = \frac{1}{2} q_{IB} \circ \Omega_{B}
\end{align}
Поверхность может быть задана как $f_s(x,y,z) = 0$,
тогда 
$$n_s = \frac{\nabla f_s}{||\nabla f_s||}.$$


\section{Модель измерений}
	
\subsection{Датчик линейного ускорения}
Обозначим $\delta r^{imu}$ смещение акселерометра,  $q_{BM}$ -- ориентацию собственных осей акселерометра относительно осей $B$, тогда для произвольного вектора
$r_B = q_{BM} \circ r_M \circ \tilde{q}_{BM}.$

Тогда, показания акселерометра $a^{imu}$ складываются из переносной, вращательной и центробежной компонент, ускорения свободного падения и ошибки измерений $e^{imu}$.
\begin{align} 
\begin{split} \label{eq:imu_mes}
&q_{BM} \circ (a^{imu} - e^{imu}) \circ \tilde{q}_{BM} = \\
&\quad \quad \quad \tilde{q}_{IB} \circ (\ddot{r}_{I} - g_I) \circ {q}_{IB}
 - {\delta r^{imu}_B}  \times \dot{\Omega}_B
 - \Omega_B \times (\delta r^{imu}_B \times \Omega_B)
\end{split}
\end{align}

Будем считать, что ошибка измерений акселерометра складывается из постоянной компоненты  и белого шума
\begin{align} 
e^{imu} = e_{0}^{imu} + \epsilon^{imu}
\end{align}
Смещение и поворот собственных осей, а также постоянную компоненту ошибки измерений $e_{0}^{imu}$ можно найти с помощью калибровки.

Удобно совместить начало собственной системы $B$ с точкой закрепления акселерометра. Тогда положение любой другой точки робота будет определяться текущей ориентацией робота и относительным смещением этой точки. Тогда, $||\delta r^{imu}_B||$ = 0, уравнение \eqref{eq:imu_mes} может быть записано в виде
\begin{align} 
\begin{split} \label{eq:imu_mes_simled}
&q_{BM} \circ (a^{imu} - e^{imu}) \circ \tilde{q}_{BM} = \tilde{q}_{IB} \circ (\ddot{r}_{I} - g_I) \circ {q}_{IB}
\end{split}
\end{align}

\subsection{Датчик угловой скорости}
Обозначим $\delta r^{\textit{gyr}}$ смещение гироскопа,  $q_{BG}$ -- ориентацию собственных осей гироскопа относительно осей $B$. Тогда, показания акселерометра $w^{\textit{gyr}}$ складываются из угловой скорости сенсора, (может быть еще чего-то) и ошибки измерений $e^{\textit{gyr}}$.

\begin{align} 
&q_{BG} \circ (w^{\textit{gyr}} - e^{\textit{gyr}}) \circ \tilde{q}_{BG} = 
\Omega_B
\\
\end{align}

Будем считать, что ошибка измерений гироскопа складывается из постоянной компоненты  и белого шума
\begin{align} 
e^{\textit{gyr}} = e_{0}^{\textit{gyr}} + \epsilon^{\textit{gyr}}
\end{align}

Смещение и поворот собственных осей, а также постоянную компоненту ошибки измерений $e_{0}^{\textit{gyr}}$ можно найти с помощью калибровки.

\subsection{Система глобальной навигации}
Обозначим $\delta r^{gnns}$ положение принимающей антенны системы глобальной навигации в $B$ . Тогда измерения положения и скорости связаны с положением начала собственной системы координат как
\begin{align} \label{eq:gnns_mes_model}
\begin{split}
&r_{gnns} = r_I + q_{IB} \circ \delta r^{gnns}_B \circ \tilde{q}_{IB} \\
&v_{gnns} = v_I + q_{IB} \circ  (\Omega_B \times \delta r^{gnns}_B) \circ \tilde{q}_{IB}
\end{split}
\end{align}

\section{Оценка состояния}
Для оценки состояния используем алгоритм SR-EKF (квадратно-корневой расширенный фильтр Калмана). Вектор состояния составим из положения, скорости, ускорения, кватерниона ориентации и угловой скорости
\begin{align} 
&x = (r_I \quad \dot{r}_I \quad \ddot{r}_I \quad q_{IB} \quad \Omega_B)
\end{align}

Инициализация алгоритма включает в себя инициализацию начального состояния и его ковариации, определение ковариации шума измерений и модели
\begin{align}
&x_0 = x|_{k=0} \\
&P_0 = P|_{k=0} \\
&R = R|_{k=0} \\
&Q = Q|_{k=0},
\end{align} 
а также разложение
\begin{align}
&\sqrt{P_0} \sqrt{P_0}^T= P_0
&\sqrt{R_0} \sqrt{R_0}^T= R_0
\end{align} 

Алгоритм работает в два этапа. На первом этапе производится априори оценка следующего состояния на основе предыдущей оценки и модели движения
\begin{align}
x_k^- = f(x_{k-1}, \delta t).
\end{align} 
Квадратный корень ковариации априори оценки состояния определяется как
\begin{align}
\begin{split}
&\sqrt{P^-_k} = \Big[ (I_n +  F_k \delta t) \sqrt{P_{k-1}} \quad Q \sqrt{\delta t}  \Big] \Theta,
\end{split}
\end{align}
где $\Theta$ -- ортогональное преобразование, приводящее левую часть к нижнему треугольному виду. Здесь
\begin{align}
\begin{split}
&F = \frac{f(x,t)}{\delta x}.
\end{split}
\end{align}

На этапе коррекции находим скорректированную ковариацию оценки и измерений, а также коэффициент усиления
\begin{align}
\begin{pmatrix}
&\sqrt{R_k} &0 \\
&K_k &\sqrt{P_k}
\end{pmatrix}
=
\begin{pmatrix}
&\sqrt{R} &H_k \sqrt{P_k^-} \\
&0 &\sqrt{P_k^-},
\end{pmatrix} \Theta
\end{align}
где $H_k$ -- линеаризованная функция измерений  
\begin{align}
\begin{split}
&H_k = \frac{\delta h(x_k^-)}{\delta x}
\end{split}
\end{align}
Оценка состояния
\begin{align}
\begin{split}
&x_k = x_k^- + K_k * (\sqrt{R_k})^{-1} \big(z_k - h(x_k^-)\big)
\end{split}
\end{align}

\subsection{Априори оценка}
Априори оценка производится интегрированием показаний акселерометра и гироскопа.
Зная калибровочные параметры датчика и воспользовавшись уравнением \eqref{eq:imu_mes_simled}, запишем
\begin{align} \label{eq:rddot_i_calib}
\begin{split}
&\ddot{r}_{I} = {q}_{IB} \circ  a^{imu}_{calib} \circ \tilde{q}_{IB} + g_I
\end{split}
\end{align}
Здесь $a^{imu}_{calib}$ -- скорректированные на поворот и постоянную компоненту ошибки показания акселерометра
\begin{align} 
\begin{split}
a^{imu}_{calib} = q_{BM} \circ (a^{imu} - e^{imu}_0) \circ \tilde{q}_{BM}
\end{split}
\end{align}
Для угловой скорости запишем
\begin{align} 
\Omega_B = w^{\textit{gyr}}_{calib}
\end{align}
\begin{align} 
&w^{\textit{gyr}}_{calib} = q_{BG} \circ (w^{\textit{gyr}} - e_0^{\textit{gyr}}) \circ \tilde{q}_{BG}
\end{align}
С учетом этих уравнений и уравнений модели  (\ref{eq:model_velocity}-\ref{eq:model_rot_velocity})
\begin{align}
\begin{split}
&F = \frac{f(x,t)}{\delta x} = \\
&\begin{pmatrix}
O_{3x3} & E_{3x3} & O_{3x3} & O_{3x4} & O_{3x3}\\
O_{3x3} & O_{3x3} & E_{3x3} & M^{\ddot{r}}_{\delta q} & O_{3x3}\\
O_{3x3} & O_{3x3} & O_{3x3} & O_{3x4} & O_{3x3}\\
O_{4x3} & O_{4x3} & O_{4x3} & M^{\dot{q}}_{\delta q} & M^{\dot{q}}_{\delta \Omega}\\
O_{3x3} & O_{3x3} & O_{3x3} & O_{3x4} & O_{3x3}
\end{pmatrix}
\end{split}
\end{align}
Здесь
\begin{align}
\begin{split}
&M^{\ddot{r}}_{\delta q} = [q_{BI} \circ  a^{imu}_{calib} \circ \tilde{q}_{BI} + g_I]_{\delta q_{BI}}
\end{split}
\end{align}
\begin{align}
\begin{split}
&M^{\dot{q}}_{\delta q} = [\frac{1}{2} q_{IB} \circ \Omega_{B}]_{\delta q_{BI}}
\end{split}
\end{align}
\begin{align}
\begin{split}
&M^{\dot{q}}_{\delta \Omega} = [\frac{1}{2} q_{IB} \circ \Omega_{B}]_{\delta \Omega_B}
\end{split}
\end{align}

\subsection{Коррекция GNNS положения и скорости}
Для коррекции используются показания систем глобальной навигации, которые позволяют оценить положение и скорость антенны
\begin{align}
z_1 = (r_{gnns} \quad v_{gnns}).
\end{align}
Используя уравнения \eqref{eq:gnns_mes_model} можем записать 
\begin{align}
\begin{split}
&H_1 =
\begin{pmatrix}
E_{3x3} & O_{3x3} & O_{3x3} & Z^r_q & O_{3x3}   \\
O_{3x3} & E_{3x3} & O_{3x3} & Z^v_q & Z^v_{\Omega}
\end{pmatrix}
\end{split}
\end{align}
Здесь
\begin{align}
\begin{split}
&Z^r_q = [q_{IB} \circ \delta r^{gnns}_B \circ \tilde{q}_{IB}]_{\delta q_{IB}} \\
&Z^v_q = [q_{IB} \circ  (\Omega_B \times \delta r^{gnns}_B) \circ \tilde{q}_{IB}]_{\delta q_{IB}} \\
&Z^v_\Omega = [q_{IB} \circ  (\Omega_B \times \delta r^{gnns}_B) \circ \tilde{q}_{IB}]_{\delta \Omega_B}
\end{split}
\end{align}

\subsection{Коррекция GNNS абсолютной величины и направления скорости}
Используя уравнения модели (\ref{eq:model_velocity}-\ref{eq:model_rot_velocity}) и уравнения для показаний GNNS датчика \eqref{eq:gnns_mes_model} можно записать
\begin{align}
\begin{split}
&v_{gnns} = v_I + q_{IB} \circ  (\Omega_B \times \delta r^{gnns}_B) \circ \tilde{q}_{IB} = \\
& = q_{IB} \circ (|v_I| \quad 0 \quad 0)^T \circ \tilde{q}_{IB} + q_{IB} \circ  (\Omega_B \times \delta r^{gnns}_B) \circ \tilde{q}_{IB}
\end{split}
\end{align}
Тогда, 
\begin{align}
z_2 = v_{gnns}.
\end{align}
\begin{align}
\begin{split}
&H_2 =
\begin{pmatrix}
O_{3x3} & \zeta^v_v & O_{3x3} & \zeta^v_q + Z^v_q & Z^v_{\Omega},
\end{pmatrix}
\end{split}
\end{align}
где
\begin{align}
\begin{split}
&\zeta^v_v = [q_{IB} \circ (|v_I| \quad 0 \quad 0)^T \circ \tilde{q}_{IB}]_{\delta v_I} \\
&\zeta^v_q = [q_{IB} \circ (|v_I| \quad 0 \quad 0)^T \circ \tilde{q}_{IB}]_{\delta q_{IB}}
\end{split}
\end{align}

\subsection{Коррекция IMU ориентации}
Используя уравнение \eqref{eq:imu_mes_simled}, можно записать
\begin{align} 
\begin{split}
&a^{imu}_{calib}  = \tilde{q}_{IB} \circ (\ddot{r}_{I} - g_I) \circ q_{IB}
\end{split}
\end{align}
Тогда, 
\begin{align}
z_3 = a^{imu}_{calib}
\end{align}
\begin{align}
\begin{split}
&H_3 =
\begin{pmatrix}
O_{3x3} & O_{3x3} & O_{3x3} & \alpha^a_q & O_{3x3},
\end{pmatrix}
\end{split}
\end{align}
где
\begin{align}
\begin{split}
&\alpha^a_q = [\tilde{q}_{IB} \circ (\ddot{r}_{I} - g_I) \circ q_{IB}]_{\delta {q}_{IB}}
\end{split}
\end{align}


\end{document}